parameters:
  - name: cloudRegion
    type: string
  - name: providerServiceConnection
    type: string
  - name: providerName
    type: string
  - name: targetName
    type: string
  - name: terraformOutputDir
    type: string
  - name: terraformSourceDir
    type: string
  - name: terraformExe
    type: string

steps:
  # Generate Terraform plan file for stack
  - template: run-tf-cmd-${{ parameters.providerName }}.yml
    parameters:
      cloudRegion: ${{ parameters.cloudRegion }}
      providerServiceConnection: ${{ parameters.providerServiceConnection }}
      targetName: ${{ parameters.targetName }}
      cmdName: plan
      cmdOptions: "-out ${{ parameters.terraformOutputDir }}/tfplan.out"
      cmdExe: ${{ parameters.terraformExe }}
      workingDirectory: ${{ parameters.terraformSourceDir }}

  # Export a JSON version of Terraform plan file
  - template: run-terragrunt-cmd-${{ parameters.providerName }}.yml
    parameters:
      cloudRegion: ${{ parameters.cloudRegion }}
      providerServiceConnection: ${{ parameters.providerServiceConnection }}
      targetName: ${{ parameters.targetName }}
      cmdName: show
      cmdOptions: "-json ${{ parameters.terraformOutputDir }}/tfplan.out > ${{ parameters.terraformOutputDir }}/tfplan.json"
      cmdExe: ${{ parameters.terraformExe }}
      workingDirectory: ${{ parameters.terraformSourceDir }}
