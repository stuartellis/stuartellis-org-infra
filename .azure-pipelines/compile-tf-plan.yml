parameters:
  - name: awsRegion
    type: string
  - name: awsServiceConnection
    type: string
  - name: tfLogLevel
    type: string
  - name: tfLogPath
    type: string
  - name: projectName
    type: string
  - name: terraformOutputDir
    type: string
  - name: terraformSourceStackDir
    type: string
  - name: terragruntExe
    type: string

steps:
  # Validate configuration for stack
  - template: run-terragrunt-cmd.yml
    parameters:
      awsRegion: ${{ parameters.awsRegion }}
      awsServiceConnection: ${{ parameters.awsServiceConnection }}
      tfLogLevel: ${{ parameters.tfLogLevel }}
      tfLogPath: ${{ parameters.tfLogPath }}/tf-validate.log
      tgCommand: validate
      tgExe: ${{ parameters.terragruntExe }}
      workingDirectory: ${{ parameters.terraformSourceStackDir }}

  # Create directory for Terraform plan, with package.json of parent project
  - task: CopyFiles@2
    displayName: Copy package.json
    inputs:
      sourceFolder: ${{ parameters.projectName }}
      contents: package.json
      targetFolder: ${{ parameters.terraformOutputDir }}

  # Generate Terraform plan file for stack
  - template: run-terragrunt-cmd.yml
    parameters:
      awsRegion: ${{ parameters.awsRegion }}
      awsServiceConnection: ${{ parameters.awsServiceConnection }}
      tfLogLevel: ${{ parameters.tfLogLevel }}
      tfLogPath: ${{ parameters.tfLogPath }}/tf-plan.log
      tgCommand: plan
      tgOptions: "-out ${{ parameters.terraformOutputDir }}/tfplan.out"
      tgExe: ${{ parameters.terragruntExe }}
      workingDirectory: ${{ parameters.terraformSourceStackDir }}

  # Export a JSON version of Terraform plan file
  - template: run-terragrunt-cmd.yml
    parameters:
      awsRegion: ${{ parameters.awsRegion }}
      awsServiceConnection: ${{ parameters.awsServiceConnection }}
      tfLogLevel: ${{ parameters.tfLogLevel }}
      tfLogPath: ${{ parameters.tfLogPath }}/tf-show.log
      tgCommand: show
      tgOptions: "-json ${{ parameters.terraformOutputDir }}/tfplan.out > ${{ parameters.terraformOutputDir }}/tfplan.json"
      tgExe: ${{ parameters.terragruntExe }}
      workingDirectory: ${{ parameters.terraformSourceStackDir }}
